"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function log(){var e;(e=console).log.apply(e,["[ APP ]--\x3e"].concat(Array.prototype.slice.call(arguments)))}var _slicedToArray=function(){function e(e,t){var n=[],o=!0,i=!1,r=void 0;try{for(var a,s=e[Symbol.iterator]();!(o=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);o=!0);}catch(e){i=!0,r=e}finally{try{!o&&s.return&&s.return()}finally{if(i)throw r}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Date.now||(Date.now=function(){return(new Date).getTime()}),Array.prototype.map||(Array.prototype.map=function(e,t){var n,o,i;if(null==this)throw new TypeError(" this is null or not defined");var r=Object(this),a=r.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(n=t),o=new Array(a),i=0;i<a;){var s,l;i in r&&(s=r[i],l=e.call(n,s,i,r),o[i]=l),i++}return o}),Object.defineProperty&&Object.getOwnPropertyDescriptor&&Object.getOwnPropertyDescriptor(Element.prototype,"textContent")&&!Object.getOwnPropertyDescriptor(Element.prototype,"textContent").get&&function(){var e=Object.getOwnPropertyDescriptor(Element.prototype,"innerText");Object.defineProperty(Element.prototype,"textContent",{get:function(){return e.get.call(this)},set:function(t){return e.set.call(this,t)}})}();var Message=function(){function e(t,n,o){return this._text=t||"Awesome!",this._id=e.idGen(),this._type="default",this._duration=4e3,this._class=" ",n&&(this.cb=o,"function"==typeof n?this.cb=n:"object"!==(void 0===n?"undefined":_typeof(n))||Array.isArray(n)||(this._type=n.type||this._type,this._id=n.id||this._id,this._duration=n.duration||this._duration,this._class=n.class||this._class)),this.cb="function"==typeof n?n:o,e.Stack[e.Stack.length]=this,this.init(),this}return e.idGen=function(){return Date.now()%1e4},e.clearAll=function(){for(var t=document.querySelectorAll("ul.prophet > li"),n=0,o=t.length;n<o;n++)t[n].classList.remove("prophet-message-active"),e.parent.removeChild(t[n])},e.prototype.init=function(){var t=this;this.cbFired=!1,this.toast=document.createElement("li");var n=this.toast;o=["message "+this._class,this._text],n.className=o[0],n.textContent=o[1],this.stylize(),n.addEventListener("click",function(){n.classList.remove("prophet-message-active"),t.cb&&(t.cb(t._id),t.cbFired=!0),setTimeout(function(){e.parent.removeChild(n)},60)});var o},e.prototype.show=function(){var t=this,n=this.toast;return e.parent.appendChild(this.toast),setTimeout(function(){n.classList.add("prophet-message-active")},10),setTimeout(function(){n.classList.remove("prophet-message-active"),t.cbFired||t.cb&&t.cb(t._id),setTimeout(function(){try{e.parent.removeChild(n)}catch(e){}},30)},this._duration),this},e.prototype.stylize=function(){var t=e.Util.find(e.stylePresets,this._type);-1!==t&&(this.toast.style.backgroundColor=e.stylePresets[t].backgroundColor,this.toast.style.color=e.stylePresets[t].color)},e.Util={find:function(e,t){return e.map(function(e){return e.type}).indexOf(t)},toDash:function(e){return e.replace(/([A-Z])/g,function(e){return"-"+e.toLowerCase()})},getSizes:function(){var e,t;return void 0!==window.innerWidth?(e=window.innerWidth,t=window.innerHeight):void 0!==document.documentElement&&void 0!==document.documentElement.clientWidth&&0!=document.documentElement.clientWidth?(e=document.documentElement.clientWidth,t=document.documentElement.clientHeight):(e=document.getElementsByTagName("body")[0].clientWidth,t=document.getElementsByTagName("body")[0].clientHeight),{width:e,height:t}},rePosition:function(){var t=e.Util.getSizes().width,n=(e.Util.getSizes().height,document.getElementsByClassName("prophet")[0]);t<240?n.style.marginLeft="10px":t>240&&t<320?n.style.marginLeft=.3*t+"px":t>320&&t<480?n.style.marginLeft=.35*t+"px":t>480&&t<600?n.style.marginLeft=.5*t+"px":t>600&&t<720?n.style.marginLeft=.6*t+"px":t>720&&t<1024?n.style.marginLeft=.7*t+"px":t>1024?n.style.marginLeft=.75*t+"px":t>1024&&(n.style.marginLeft=.75*t+"px")}},e.Dbg={stackTrace:function(){return console.dir(e.Stack)},presets:function(){return console.dir(e.stylePresets)}},e.parent=document.getElementsByClassName("prophet")[0],e.stylePresets=[{type:"default",backgroundColor:"#1c2e2d",color:"#FAFAFA"},{type:"success",backgroundColor:"#4daf7c",color:"#FAFAFA"},{type:"error",backgroundColor:"#D45A43",color:"#FAFAFA"}],e.config={types:function(t){for(var n,o=0,i=(t=[].concat(t)).length;o<i;o++){var r=e.Util.find(e.stylePresets,t[o].type);if(n=t[o],-1!==r)for(var a in n)e.stylePresets[r][a]=n[a];else e.stylePresets[e.stylePresets.length]=n}}},e.Stack=[],e}(),El=function(){function e(t){_classCallCheck(this,e),"string"==typeof t&&(t=document.querySelector(t)),this.$el=t}return _createClass(e,[{key:"exists",value:function(){return!!this.$el}},{key:"get",value:function(){return this.$el}},{key:"show",value:function(){return this.$el.style.display="block",this}},{key:"showInline",value:function(){return this.$el.style.display="inline",this}},{key:"hide",value:function(){return this.$el.style.display="none",this}},{key:"disable",value:function(){return this.$el.disabled=!0,this}},{key:"enable",value:function(){return this.$el.disabled=!1,this}},{key:"style",value:function(e,t){return this.$el.style[e]=t,this}},{key:"addClass",value:function(e){return this.$el.className+=" "+e,this}},{key:"removeClass",value:function(e){return this.$el.className=this.$el.className.replace(e,"").replace("  "," "),this}},{key:"remove",value:function(){return this.$el.parentNode.removeChild(this.$el),this}},{key:"setRandomBackground",value:function(e){var t=e.path,n=void 0===t?"":t,o=e.range,i=void 0===o?[0,5]:o,r=e.length,a=void 0===r?3:r,s=e.ext,l=void 0===s?"jpg":s,c=_slicedToArray(i,2),u=c[0],d=c[1],h=Math.round(Math.random()*(d-u)+u),p=("0".repeat(a)+h).substr(-a);this.$el.style.backgroundImage="url("+n+"/"+p+"."+l+")"}},{key:"appear",value:function(){return this.style("opacity",1),this}},{key:"focus",value:function(){return this.$el.focus(),this}},{key:"html",value:function(e){return void 0===e?this.$el.innerHTML:(this.$el.innerHTML=e,this)}},{key:"appendHtml",value:function(e){return this.$el.innerHTML+=e,this}},{key:"prependHtml",value:function(e){return this.$el.innerHTML=e+this.html(),this}},{key:"val",value:function(e){return void 0===e?this.$el.value:(this.$el.value=e,this)}},{key:"clear",value:function(){return this.$el.value="",this}},{key:"isVisible",value:function(){return""===this.$el.style.display||this.$el.style.display.match(/(block|inline|inline-block)/)}},{key:"toggle",value:function(){return this.isVisible()?(this.hide(),this):(this.show(),this)}},{key:"caretEnd",value:function(){if(this.$el.focus(),void 0!==window.getSelection&&void 0!==document.createRange){var e=document.createRange();e.selectNodeContents(this.$el),e.collapse(!1);var t=window.getSelection();t.removeAllRanges(),t.addRange(e)}else if(void 0!==document.body.createTextRange){var n=document.body.createTextRange();n.moveToElementText(this.$el),n.collapse(!1),n.select()}return this}},{key:"src",value:function(e){return this.$el.src=e,this}},{key:"scrollBottom",value:function(){return this.$el.scrollTop=this.$el.scrollHeight,this}},{key:"on",value:function(e,t){return this.$el.addEventListener(e,t),this}}],[{key:"injectStyles",value:function(e){var t=document.createElement("style");t.type="text/css",t.innerHTML=e,document.getElementsByTagName("head")[0].appendChild(t)}}]),e}(),InstabuddyEvents=function(){function e(t){_classCallCheck(this,e),this.app=t}return _createClass(e,[{key:"channel",value:function(e){var t=this,n=(e.type,e.data),o=e.error;if(this.log("channel:",n),o)throw new Error(o);n&&n.buttons&&n.buttons.length?n.buttons.map(function(e){console.log("button:",e);var n=t.app.addButton(null,e);t.app.addAudio(n,e)}):this.log("EMPTY channel")}},{key:"buttonSaved",value:function(e){e.type;var t=e.data,n=e.error;n?this.log("ERROR SAVING BUTTON",n):this.log("BUTTON SAVED",t)}},{key:"log",value:function(){var e;(e=console).log.apply(e,["[ EVENTS ]--\x3e"].concat(Array.prototype.slice.call(arguments)))}},{key:"play",value:function(e){var t=this,n=(e.type,e.data),o=(e.error,n.channel),i=n.id,r=n.src;if(this.log("BROADCAST PLAY @"+o+":",r),this.app.channel===o){var a=new El("#btn-"+i);a.exists()&&(this.app.$audio.src=r,this.app.$audio.play(),a.addClass("playing"),setTimeout(function(){t.log("BROADCAST PLAYING stopped"),a.removeClass("playing")},this.app.recordingTime))}}}]),e}(),App=function(){function e(t){_classCallCheck(this,e),this.$buttons=new El("#buttons"),this.$audio=document.querySelector("audio"),this.$addButton=new El("#add"),this.$error=new El("#error"),this.audioCollection={},this.recorder=null,this.recordingTime=3e3,this.channel=this.getChannelName(),this.url=location.href,this.colors=["color1","color2","color3","color4","color5","color6","color7","color8"],this.downloadLink=document.querySelector("#download"),this.messages={noAudioRecording:"Your browser does not support audio recording, sorry.",noWebSocketSupport:"InstaBuddy is not fully supported on your browser. Please, try with latest Chrome or Firefox :)",notSupported:"InstaBuddy is not fully supported on your browser. Please, try with latest Chrome or Firefox :)",noAudioPlayback:"Audio playback is not supported on your browser. Please, try with latest Chrome or Firefox :)"},this.alerts={playbackError:new Message("Oops, playback failed.",{type:"error"}),playbackErrorRepeated:new Message("\n        Playback failed several times. Maybe your browser does not support webm audio.\n      ",{type:"error"}),clipboardCopyOk:new Message("Copied to clipboard!",{type:"success"}),noAudioPlayback:new Message("Audio playback is not supported on your browser.",{type:"error"})},this.playing=!1,this.recording=!1,this.connected=!1,this.playbackFailedCount=0,this.mode=t,this.init()}return _createClass(e,[{key:"init",value:function(){var e=this;"normal"===this.mode&&(this.initRecording(),this.initClipboard()),this.connect(function(){e.events=new InstabuddyEvents(e),"standalone"!==e.mode&&e.getChannel()}),this.supportsWebm()||this.alert("noAudioPlayback")}},{key:"supportsWebm",value:function(){return!!this.$audio.canPlayType("audio/webm")}},{key:"initClipboard",value:function(){var e=this;Clipboard.isSupported()&&new Clipboard("i.share").on("success",function(t){e.alerts.clipboardCopyOk.show()})}},{key:"initRecording",value:function(){var e=this;try{navigator.mediaDevices.getUserMedia({audio:!0}).then(function(t){try{e.recorder=new MediaRecorder(t)}catch(t){e.handleError("noAudioRecording",t)}}).catch(function(t){e.handleError("noAudioRecording",t)})}catch(e){this.handleError("noAudioRecording",e)}}},{key:"getChannelName",value:function(){return location.pathname.match("play")?location.pathname.match(/channel\/(.*?)\//)[1]:location.pathname.replace("/channel/","")}},{key:"handleError",value:function(e,t){var n=this;(({noAudioRecording:function(){log(t),"normal"===n.mode&&n.$addButton.hide(),alert(n.messages.noAudioRecording)},noWebSocketSupport:function(){log(t),alert(n.messages.noWebSocketSupport)},noAudioPlayback:function(){log(t),alert(n.messages.noAudioPlayback),n.$buttons.hide(),n.showError(n.messages.noAudioPlayback)}})[e]||function(){alert(n.messages.notSupported)})()}},{key:"showError",value:function(e){this.$error.html(e).show()}},{key:"connect",value:function(e){var t=this;if(!1 in window)alert(this.messages.noWebSocketSupport);else{var n="ws";"https:"===location.protocol&&(n="wss"),this.ws=new ReconnectingWebSocket(n+"://"+location.host),this.ws.binaryType="arraybuffer",this.ws.onopen=function(){t.connected?log("WebSocket reconnected."):(log("WebSocket connected."),t.connected=!0,"function"==typeof e&&e())},this.ws.onmessage=function(e){var n=JSON.parse(e.data),o=n.type,i=n.data,r=n.error;log("Got message '"+o+"'",i,r),"function"==typeof t.events[o]&&t.events[o]({type:o,data:i,error:r})},this.ws.onerror=function(e){log("ERROR:",e)}}}},{key:"send",value:function(e){var t=JSON.stringify(e);this.ws.send(t)}},{key:"getChannel",value:function(){log("Get channel..."),this.send({type:"getChannel",name:this.channel})}},{key:"onButtonClick",value:function(e){if("share"!==e.target.className||Clipboard.isSupported()){var t=e.target.dataset.id;if(t)return this.audioCollection[t].src?this.play(t):void this.record(t,e)}else this.openButtonUrl(e.target)}},{key:"openButtonUrl",value:function(e){var t=e.dataset["clipboard-text"];t&&window.open(t)}},{key:"record",value:function(e,t){var n=this;if(!this.recording){this.recording=!0,log("recording started",e);var o=new El(t.target);o.addClass("recording");var i=[];this.recorder.start(),this.recorder.ondataavailable=function(t){if(i.push(t.data),"inactive"===n.recorder.state){var o=new Blob(i,{type:"audio/webm"});n.audioCollection[e].src=URL.createObjectURL(o),n.saveButton(n.audioCollection[e])}},setTimeout(function(){n.recorder.stop(),log("recording stopped",e),o.removeClass("recording"),o.removeClass("empty"),n.recording=!1},this.recordingTime)}}},{key:"sendBinary",value:function(e,t){var n=t.id,o=t.name,i=t.channel,r=new XMLHttpRequest,a="/binary/"+i+"/"+n+"/"+o;r.open("POST",a,!0),r.send(e)}},{key:"saveButton",value:function(e){var t=this;fetch(e.src).then(function(n){n.arrayBuffer().then(function(n){var o={id:e.id,name:e.name,channel:t.channel};t.sendBinary(n,o)})})}},{key:"play",value:function(e){var t=this;if(!this.playing){log("play",e),this.playing=!0;var n=new El("#btn-"+e);n.addClass("playing");var o=this.audioCollection[e].src;this.$audio.src=o,setTimeout(function(){log("playing stopped"),n.removeClass("playing"),t.playing=!1},this.recordingTime);try{this.$audio.play().then(function(){}).catch(function(e){log(e),"The operation is not supported."!==e.message&&(t.playbackFailedCount>3?t.alerts.playbackErrorRepeated.show():(t.alerts.playbackError.show(),t.playbackFailedCount+=1))})}catch(t){log("ERROR PLAYING '"+e+"': "+o,t)}this.sendPlay(e,o)}}},{key:"sendPlay",value:function(e,t){this.send({type:"play",data:{channel:this.channel,id:e,src:t}})}},{key:"download",value:function(e,t){console.log("download:",t),e.stopPropagation(),e.preventDefault(),this.downloadLink.href=this.audioCollection[t].src,this.downloadLink.download=this.audioCollection[t].name.replace(" ","-")+".webm",this.downloadLink.click()}},{key:"onKey",value:function(e){}},{key:"getRandomColor",value:function(){var e=this.colors.length,t=Math.round(Math.random()*e);return this.colors[t]}},{key:"removeButton",value:function(e,t){e.stopPropagation(),confirm("Delete this InstantButton?")&&(new El("#btn-"+t).remove(),this.send({type:"removeButton",channel:this.channel,id:t}))}},{key:"addButton",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.id,o=t.name;if(e&&e.stopPropagation(),(o=o||prompt("Button name?"))&&o.trim()){var i=n?"":" empty",r="btn-"+(n=n||(new Date).getTime()),a=this.getRandomColor();return this.$buttons.prependHtml('\n      <div id="'+r+'" data-id="'+n+'" class="btn'+i+" "+a+'">\n        <p class="ellipsis">'+o+'</p>\n        <div class="button-actions">\n          <i title="Download" class="download" onclick="app.download(event, '+n+')">💾</i>\n          <i\n            title="Share" class="share"\n            data-clipboard-text="'+this.url+"/play/"+n+'"\n          >🔗</i>\n          <i title="Delete" class="remove" onclick="app.removeButton(event, '+n+')">⌫</i>\n        </div>\n      </div>\n    '),this.addAudio(n,{id:n,name:o,color:a}),n}}},{key:"getButtonLink",value:function(e,t){console.log("SHARE BUTTON",t),e.stopPropagation(),e.preventDefault();var n=this.url+"/play/"+t;console.log(n)}},{key:"addAudio",value:function(e,t){this.audioCollection[e]=t}}]),e}(),app=new App(mode);