"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function log(){var e;(e=console).log.apply(e,["[ APP ]--\x3e"].concat(Array.prototype.slice.call(arguments)))}var _slicedToArray=function(){function e(e,t){var n=[],o=!0,i=!1,a=void 0;try{for(var r,l=e[Symbol.iterator]();!(o=(r=l.next()).done)&&(n.push(r.value),!t||n.length!==t);o=!0);}catch(e){i=!0,a=e}finally{try{!o&&l.return&&l.return()}finally{if(i)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),El=function(){function e(t){_classCallCheck(this,e),"string"==typeof t&&(t=document.querySelector(t)),this.$el=t}return _createClass(e,[{key:"exists",value:function(){return!!this.$el}},{key:"get",value:function(){return this.$el}},{key:"show",value:function(){return this.$el.style.display="block",this}},{key:"showInline",value:function(){return this.$el.style.display="inline",this}},{key:"hide",value:function(){return this.$el.style.display="none",this}},{key:"disable",value:function(){return this.$el.disabled=!0,this}},{key:"enable",value:function(){return this.$el.disabled=!1,this}},{key:"style",value:function(e,t){return this.$el.style[e]=t,this}},{key:"addClass",value:function(e){return this.$el.className+=" "+e,this}},{key:"removeClass",value:function(e){return this.$el.className=this.$el.className.replace(e,"").replace("  "," "),this}},{key:"remove",value:function(){return this.$el.parentNode.removeChild(this.$el),this}},{key:"setRandomBackground",value:function(e){var t=e.path,n=void 0===t?"":t,o=e.range,i=void 0===o?[0,5]:o,a=e.length,r=void 0===a?3:a,l=e.ext,s=void 0===l?"jpg":l,c=_slicedToArray(i,2),u=c[0],d=c[1],h=Math.round(Math.random()*(d-u)+u),p=("0".repeat(r)+h).substr(-r);this.$el.style.backgroundImage="url("+n+"/"+p+"."+s+")"}},{key:"appear",value:function(){return this.style("opacity",1),this}},{key:"focus",value:function(){return this.$el.focus(),this}},{key:"html",value:function(e){return void 0===e?this.$el.innerHTML:(this.$el.innerHTML=e,this)}},{key:"appendHtml",value:function(e){return this.$el.innerHTML+=e,this}},{key:"prependHtml",value:function(e){return this.$el.innerHTML=e+this.html(),this}},{key:"val",value:function(e){return void 0===e?this.$el.value:(this.$el.value=e,this)}},{key:"clear",value:function(){return this.$el.value="",this}},{key:"isVisible",value:function(){return""===this.$el.style.display||this.$el.style.display.match(/(block|inline|inline-block)/)}},{key:"toggle",value:function(){return this.isVisible()?(this.hide(),this):(this.show(),this)}},{key:"caretEnd",value:function(){if(this.$el.focus(),void 0!==window.getSelection&&void 0!==document.createRange){var e=document.createRange();e.selectNodeContents(this.$el),e.collapse(!1);var t=window.getSelection();t.removeAllRanges(),t.addRange(e)}else if(void 0!==document.body.createTextRange){var n=document.body.createTextRange();n.moveToElementText(this.$el),n.collapse(!1),n.select()}return this}},{key:"src",value:function(e){return this.$el.src=e,this}},{key:"scrollBottom",value:function(){return this.$el.scrollTop=this.$el.scrollHeight,this}},{key:"on",value:function(e,t){return this.$el.addEventListener(e,t),this}}],[{key:"injectStyles",value:function(e){var t=document.createElement("style");t.type="text/css",t.innerHTML=e,document.getElementsByTagName("head")[0].appendChild(t)}}]),e}(),InstabuddyEvents=function(){function e(t){_classCallCheck(this,e),this.app=t}return _createClass(e,[{key:"channel",value:function(e){var t=this,n=(e.type,e.data),o=e.error;if(this.log("channel:",n),o)throw new Error(o);n&&n.buttons&&n.buttons.length?n.buttons.map(function(e){console.log("button:",e);var n=t.app.addButton(null,e);t.app.addAudio(n,e)}):this.log("EMPTY channel")}},{key:"buttonSaved",value:function(e){e.type;var t=e.data,n=e.error;n?this.log("ERROR SAVING BUTTON",n):this.log("BUTTON SAVED",t)}},{key:"log",value:function(){var e;(e=console).log.apply(e,["[ EVENTS ]--\x3e"].concat(Array.prototype.slice.call(arguments)))}},{key:"play",value:function(e){var t=this,n=(e.type,e.data),o=(e.error,n.channel),i=n.id,a=n.src;if(this.log("BROADCAST PLAY @"+o+":",a),this.app.channel===o){var r=new El("#btn-"+i);r.exists()&&(this.app.$audio.src=a,this.app.$audio.play(),r.addClass("playing"),setTimeout(function(){t.log("BROADCAST PLAYING stopped"),r.removeClass("playing")},this.app.recordingTime))}}}]),e}(),App=function(){function e(t){var n=this;_classCallCheck(this,e),this.$buttons=new El("#buttons"),this.$audio=document.querySelector("audio"),this.$addButton=new El("#add"),this.$error=new El("#error"),this.audioCollection={},this.recorder=null,this.recordingTime=3e3,this.channel=this.getChannelName(),this.url=location.href,this.colors=["color1","color2","color3","color4","color5","color6","color7","color8"],this.downloadLink=document.querySelector("#download"),this.messages={noAudioRecording:"Your browser does not support audio recording, sorry.",noWebSocketSupport:"InstaBuddy is not fully supported on your browser. Please, try with latest Chrome or Firefox :)",notSupported:"InstaBuddy is not fully supported on your browser. Please, try with latest Chrome or Firefox :)",noAudioPlayback:"Audio playback is not supported on your browser. Please, try with latest Chrome or Firefox :)"},this.playing=!1,this.recording=!1,this.connected=!1,this.mode=t,"normal"===this.mode&&(this.initRecording(),this.initClipboard()),!1 in window?alert(this.messages.noWebSocketSupport):this.connect(function(){n.events=new InstabuddyEvents(n),"standalone"!==n.mode&&n.getChannel()})}return _createClass(e,[{key:"initClipboard",value:function(){Clipboard.isSupported()&&new Clipboard("i.share").on("success",function(e){alert("Copied to Clipboard!")})}},{key:"initRecording",value:function(){var e=this;try{navigator.mediaDevices.getUserMedia({audio:!0}).then(function(t){try{e.recorder=new MediaRecorder(t)}catch(t){e.handleError("noAudioRecording",t)}}).catch(function(t){e.handleError("noAudioRecording",t)})}catch(e){this.handleError("noAudioRecording",e)}}},{key:"getChannelName",value:function(){return location.pathname.match("play")?location.pathname.match(/channel\/(.*?)\//)[1]:location.pathname.replace("/channel/","")}},{key:"handleError",value:function(e,t){var n=this;(({noAudioRecording:function(){log(t),"normal"===n.mode&&n.$addButton.hide(),alert(n.messages.noAudioRecording)},noWebSocketSupport:function(){log(t),alert(n.messages.noWebSocketSupport)},noAudioPlayback:function(){log(t),alert(n.messages.noAudioPlayback),n.$buttons.hide(),n.showError(n.messages.noAudioPlayback)}})[e]||function(){alert(n.messages.notSupported)})()}},{key:"showError",value:function(e){this.$error.html(e).show()}},{key:"connect",value:function(e){var t=this,n="ws";"https:"===location.protocol&&(n="wss"),this.ws=new ReconnectingWebSocket(n+"://"+location.host),this.ws.binaryType="arraybuffer",this.ws.onopen=function(){t.connected?log("WebSocket reconnected."):(log("WebSocket connected."),t.connected=!0,"function"==typeof e&&e())},this.ws.onmessage=function(e){var n=JSON.parse(e.data),o=n.type,i=n.data,a=n.error;log("Got message '"+o+"'",i,a),"function"==typeof t.events[o]&&t.events[o]({type:o,data:i,error:a})},this.ws.onerror=function(e){log("ERROR:",e)}}},{key:"send",value:function(e){var t=JSON.stringify(e);this.ws.send(t)}},{key:"getChannel",value:function(){log("Get channel..."),this.send({type:"getChannel",name:this.channel})}},{key:"onButtonClick",value:function(e){if("share"!==e.target.className||Clipboard.isSupported()){var t=e.target.dataset.id;if(t)return this.audioCollection[t].src?this.play(t):void this.record(t,e)}else this.openButtonUrl(e.target)}},{key:"openButtonUrl",value:function(e){var t=e.dataset["clipboard-text"];t&&window.open(t)}},{key:"record",value:function(e,t){var n=this;if(!this.recording){this.recording=!0,log("recording started",e);var o=new El(t.target);o.addClass("recording");var i=[];this.recorder.start(),this.recorder.ondataavailable=function(t){if(i.push(t.data),"inactive"===n.recorder.state){var o=new Blob(i,{type:"audio/webm"});n.audioCollection[e].src=URL.createObjectURL(o),n.saveButton(n.audioCollection[e])}},setTimeout(function(){n.recorder.stop(),log("recording stopped",e),o.removeClass("recording"),o.removeClass("empty"),n.recording=!1},this.recordingTime)}}},{key:"sendBinary",value:function(e,t){var n=t.id,o=t.name,i=t.channel,a=new XMLHttpRequest,r="/binary/"+i+"/"+n+"/"+o;a.open("POST",r,!0),a.send(e)}},{key:"saveButton",value:function(e){var t=this;fetch(e.src).then(function(n){n.arrayBuffer().then(function(n){var o={id:e.id,name:e.name,channel:t.channel};t.sendBinary(n,o)})})}},{key:"play",value:function(e){var t=this;if(!this.playing){log("play",e),this.playing=!0;var n=new El("#btn-"+e);n.addClass("playing");var o=this.audioCollection[e].src;this.$audio.src=o;try{this.$audio.play().then(function(){}).catch(function(e){t.handleError("noAudioPlayback",e)})}catch(t){log("ERROR PLAYING '"+e+"': "+o,t)}this.sendPlay(e,o),setTimeout(function(){log("playing stopped"),n.removeClass("playing"),t.playing=!1},this.recordingTime)}}},{key:"sendPlay",value:function(e,t){this.send({type:"play",data:{channel:this.channel,id:e,src:t}})}},{key:"download",value:function(e,t){console.log("download:",t),e.stopPropagation(),e.preventDefault(),this.downloadLink.href=this.audioCollection[t].src,this.downloadLink.download=this.audioCollection[t].name.replace(" ","-")+".webm",this.downloadLink.click()}},{key:"onKey",value:function(e){}},{key:"getRandomColor",value:function(){var e=this.colors.length,t=Math.round(Math.random()*e);return this.colors[t]}},{key:"removeButton",value:function(e,t){e.stopPropagation(),new El("#btn-"+t).remove(),this.send({type:"removeButton",channel:this.channel,id:t})}},{key:"addButton",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.id,o=t.name;if(e&&e.stopPropagation(),(o=o||prompt("Button name?"))&&o.trim()){var i=n?"":" empty",a="btn-"+(n=n||(new Date).getTime()),r=this.getRandomColor();return this.$buttons.prependHtml('\n      <div id="'+a+'" data-id="'+n+'" class="btn'+i+" "+r+'">\n        <p class="ellipsis">'+o+'</p>\n        <div class="button-actions">\n          <i title="Download" class="download" onclick="app.download(event, '+n+')">💾</i>\n          <i\n            title="Share" class="share"\n            data-clipboard-text="'+this.url+"/play/"+n+'"\n          >🔗</i>\n          <i title="Delete" class="remove" onclick="app.removeButton(event, '+n+')">⌫</i>\n        </div>\n      </div>\n    '),this.addAudio(n,{id:n,name:o,color:r}),n}}},{key:"getButtonLink",value:function(e,t){console.log("SHARE BUTTON",t),e.stopPropagation(),e.preventDefault();var n=this.url+"/play/"+t;console.log(n)}},{key:"addAudio",value:function(e,t){this.audioCollection[e]=t}}]),e}(),app=new App(mode);