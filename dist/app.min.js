"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function log(){var e;(e=console).log.apply(e,["[ APP ]--\x3e"].concat(Array.prototype.slice.call(arguments)))}var _slicedToArray=function(){function e(e,t){var n=[],o=!0,i=!1,a=void 0;try{for(var l,r=e[Symbol.iterator]();!(o=(l=r.next()).done)&&(n.push(l.value),!t||n.length!==t);o=!0);}catch(e){i=!0,a=e}finally{try{!o&&r.return&&r.return()}finally{if(i)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),El=function(){function e(t){_classCallCheck(this,e),"string"==typeof t&&(t=document.querySelector(t)),this.$el=t}return _createClass(e,[{key:"get",value:function(){return this.$el}},{key:"show",value:function(){return this.$el.style.display="block",this}},{key:"showInline",value:function(){return this.$el.style.display="inline",this}},{key:"hide",value:function(){return this.$el.style.display="none",this}},{key:"disable",value:function(){return this.$el.disabled=!0,this}},{key:"enable",value:function(){return this.$el.disabled=!1,this}},{key:"style",value:function(e,t){return this.$el.style[e]=t,this}},{key:"addClass",value:function(e){return this.$el.className+=" "+e,this}},{key:"removeClass",value:function(e){return this.$el.className=this.$el.className.replace(e,"").replace("  "," "),this}},{key:"remove",value:function(){return this.$el.parentNode.removeChild(this.$el),this}},{key:"setRandomBackground",value:function(e){var t=e.path,n=void 0===t?"":t,o=e.range,i=void 0===o?[0,5]:o,a=e.length,l=void 0===a?3:a,r=e.ext,s=void 0===r?"jpg":r,c=_slicedToArray(i,2),u=c[0],d=c[1],h=Math.round(Math.random()*(d-u)+u),v=("0".repeat(l)+h).substr(-l);this.$el.style.backgroundImage="url("+n+"/"+v+"."+s+")"}},{key:"appear",value:function(){return this.style("opacity",1),this}},{key:"focus",value:function(){return this.$el.focus(),this}},{key:"html",value:function(e){return void 0===e?this.$el.innerHTML:(this.$el.innerHTML=e,this)}},{key:"appendHtml",value:function(e){return this.$el.innerHTML+=e,this}},{key:"prependHtml",value:function(e){return this.$el.innerHTML=e+this.html(),this}},{key:"val",value:function(e){return void 0===e?this.$el.value:(this.$el.value=e,this)}},{key:"clear",value:function(){return this.$el.value="",this}},{key:"isVisible",value:function(){return""===this.$el.style.display||this.$el.style.display.match(/(block|inline|inline-block)/)}},{key:"toggle",value:function(){return this.isVisible()?(this.hide(),this):(this.show(),this)}},{key:"caretEnd",value:function(){if(this.$el.focus(),void 0!==window.getSelection&&void 0!==document.createRange){var e=document.createRange();e.selectNodeContents(this.$el),e.collapse(!1);var t=window.getSelection();t.removeAllRanges(),t.addRange(e)}else if(void 0!==document.body.createTextRange){var n=document.body.createTextRange();n.moveToElementText(this.$el),n.collapse(!1),n.select()}return this}},{key:"src",value:function(e){return this.$el.src=e,this}},{key:"scrollBottom",value:function(){return this.$el.scrollTop=this.$el.scrollHeight,this}},{key:"on",value:function(e,t){return this.$el.addEventListener(e,t),this}}],[{key:"injectStyles",value:function(e){var t=document.createElement("style");t.type="text/css",t.innerHTML=e,document.getElementsByTagName("head")[0].appendChild(t)}}]),e}(),InstabuddyEvents=function(){function e(t){_classCallCheck(this,e),this.app=t}return _createClass(e,[{key:"channel",value:function(e){var t=this,n=(e.type,e.data),o=e.error;if(this.log("channel:",n),o)throw new Error(o);n&&n.buttons&&n.buttons.length?n.buttons.map(function(e){console.log("button:",e);var n=t.app.addButton(null,e);t.app.addAudio(n,e)}):this.log("EMPTY channel")}},{key:"buttonSaved",value:function(e){e.type;var t=e.data,n=e.error;n?this.log("ERROR SAVING BUTTON",n):this.log("BUTTON SAVED",t)}},{key:"log",value:function(){var e;(e=console).log.apply(e,["[ EVENTS ]--\x3e"].concat(Array.prototype.slice.call(arguments)))}},{key:"play",value:function(e){this.log("PLAY",e)}}]),e}(),App=function(){function e(){var t=this;_classCallCheck(this,e),this.$buttons=new El("#buttons"),this.$audio=document.querySelector("audio"),this.$addButton=new El("#add"),this.audioCollection={},this.recorder=null,this.recordingTime=3e3,this.channel=location.pathname.replace("/channel/",""),this.colors=["color1","color2","color3","color4","color5","color6","color7","color8"],this.downloadLink=document.querySelector("#download"),navigator.mediaDevices.getUserMedia({audio:!0}).then(function(e){t.recorder=new MediaRecorder(e)}).catch(function(e){log(e),alert("Your browser does not support audio recording, sorry."),t.$addButton.hide()}),this.connect(function(){t.events=new InstabuddyEvents(t),t.getChannel()})}return _createClass(e,[{key:"connect",value:function(e){var t=this,n="ws";"https:"===location.protocol&&(n="wss"),this.ws=new WebSocket(n+"://"+location.host),this.ws.binaryType="arraybuffer",this.ws.onopen=function(){log("WebSocket connected."),"function"==typeof e&&e()},this.ws.onmessage=function(e){var n=JSON.parse(e.data),o=n.type,i=n.data,a=n.error;log("Got message '"+o+"'",i,a),"function"==typeof t.events[o]&&t.events[o]({type:o,data:i,error:a})},this.ws.onerror=function(e){log("ERROR:",e)}}},{key:"send",value:function(e){var t=JSON.stringify(e);this.ws.send(t)}},{key:"getChannel",value:function(){log("Get channel..."),this.send({type:"getChannel",name:this.channel})}},{key:"onButtonClick",value:function(e){var t=e.target.dataset.id;if(t)return this.audioCollection[t].src?this.play(t):void this.record(t,e)}},{key:"record",value:function(e,t){var n=this;log("recording started",e);var o=new El(t.target);o.addClass("recording");var i=[];this.recorder.start(),this.recorder.ondataavailable=function(t){if(i.push(t.data),"inactive"===n.recorder.state){var o=new Blob(i,{type:"audio/webm"});n.audioCollection[e].src=URL.createObjectURL(o),n.saveButton(n.audioCollection[e])}},setTimeout(function(){n.recorder.stop(),log("recording stopped",e),o.removeClass("recording"),o.removeClass("empty")},this.recordingTime)}},{key:"sendBinary",value:function(e,t){var n=t.id,o=t.name,i=t.channel,a=new XMLHttpRequest,l="/binary/"+i+"/"+n+"/"+o;a.open("POST",l,!0),a.send(e)}},{key:"saveButton",value:function(e){var t=this;fetch(e.src).then(function(n){n.arrayBuffer().then(function(n){console.log(n);var o={id:e.id,name:e.name,channel:t.channel};t.sendBinary(n,o)})})}},{key:"play",value:function(e){log("play",e);var t=new El("#btn-"+e);t.addClass("playing");var n=this.audioCollection[e].src;this.$audio.src=n,this.$audio.play(),this.sendPlay(n),setTimeout(function(){log("playing stopped"),t.removeClass("playing")},this.recordingTime)}},{key:"sendPlay",value:function(e){this.send({type:"play",channel:this.channel,src:e})}},{key:"download",value:function(e,t){console.log("download:",t),e.stopPropagation(),e.preventDefault(),this.downloadLink.href=this.audioCollection[t].src,this.downloadLink.download=this.audioCollection[t].name.replace(" ","-")+".webm",this.downloadLink.click()}},{key:"onKey",value:function(e){}},{key:"getRandomColor",value:function(){var e=this.colors.length,t=Math.round(Math.random()*e);return this.colors[t]}},{key:"removeButton",value:function(e,t){e.stopPropagation(),new El("#btn-"+t).remove(),this.send({type:"removeButton",channel:this.channel,id:t})}},{key:"addButton",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.id,o=t.name;if(e&&e.stopPropagation(),(o=o||prompt("Button name?"))&&o.trim()){var i=n?"":" empty",a="btn-"+(n=n||(new Date).getTime()),l=this.getRandomColor();return this.$buttons.prependHtml('\n      <div id="'+a+'" data-id="'+n+'" class="btn'+i+" "+l+'">\n        <p class="ellipsis">'+o+'</p>\n        <div class="button-actions">\n          <i title="Download" class="download" onclick="app.download(event, '+n+')">ðŸ’¾</i>\n          <i title="Delete" class="remove" onclick="app.removeButton(event, '+n+')">âŒ«</i>\n        </div>\n      </div>\n    '),this.addAudio(n,{id:n,name:o,color:l}),n}}},{key:"addAudio",value:function(e,t){this.audioCollection[e]=t}}]),e}(),app=new App;